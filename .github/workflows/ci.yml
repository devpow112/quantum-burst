name: CI
on:
  pull_request:
  push:
    branches:
      - main
jobs:
  check-formatting-c:
    name: Check formatting (C)
    runs-on: ubuntu-latest
    env:
      CLANG_FORMAT_VERSION: 12
    steps:
      - name: Install packages
        run: |
          URL='https://apt.llvm.org/'
          TOOLCHAIN='llvm-toolchain-focal-12'
          PACKAGE="clang-format-${CLANG_FORMAT_VERSION}"
          wget -O - ${URL}llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb ${URL}focal/ ${TOOLCHAIN} main"
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y ${PACKAGE}
      - name: Checkout
        uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 0
      - name: Check formatting
        run: >
          find . -type f -iregex '^.*\.\(c\|c.in\|h\)$' -print0 |
          xargs -0 clang-format-${CLANG_FORMAT_VERSION} --dry-run --Werror
  build:
    name: Build
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build-type: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4
        with:
          submodules: true
      - name: Build
        run: ./build.ps1 -BuildType ${{matrix.build-type}}
